<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø³ÙŠÙ†Ù…Ø§ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background-color: #1a1a1a; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { color: #e50914; text-transform: uppercase; letter-spacing: 2px; }
    .control-panel { background: #333; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; }
    input { padding: 10px; width: 70%; border-radius: 5px; border: none; outline: none; }
    button { padding: 10px 20px; background: #e50914; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    button:hover { background: #b20710; }
    .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  </style>
</head>
<body>

<div class="container">
  <h1>ØºØ±ÙØ© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h1>
  
  <div class="control-panel">
    <input type="text" id="videoLink" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ù‡Ù†Ø§ (Ù…Ø«Ø§Ù„: https://youtu.be/xyz...)">
    <button onclick="sendVideo()">ØªØ´ØºÙŠÙ„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
  </div>

  <div class="video-wrapper">
    <div id="player"></div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
  const socket = io();
  let player;
  let isRemoteUpdate = false; 
  
  // Ù‚ÙŠÙ…Ø© ØªØ¹ÙˆÙŠØ¶ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø¬Ø±Ø¨ 0.2 Ø£Ùˆ 0.3 Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øª Ø¨Ø·ÙŠØ¦Ø§Ù‹)
  const latencyCorrection = 0.25; 

  // 1. Ø¥Ø¹Ø¯Ø§Ø¯ YouTube API
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      height: '390',
      width: '640',
      videoId: 'M7lc1UVf-VE',
      playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1 },
      events: {
        'onStateChange': onPlayerStateChange
      }
    });
  }

  function getVideoId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }

  function sendVideo() {
    const url = document.getElementById('videoLink').value;
    const videoId = getVideoId(url);
    if(videoId) socket.emit('change_video', videoId);
  }

  // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø®Ø§Ø¯Ù…
  function onPlayerStateChange(event) {
    // Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø§Ø¯Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ù†ÙØ³Ù‡ (Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠ)
    if (isRemoteUpdate) return;

    if (event.data === YT.PlayerState.PLAYING) {
      socket.emit('play_video');
      socket.emit('sync_time', player.getCurrentTime());
    } 
    else if (event.data === YT.PlayerState.PAUSED) {
      socket.emit('pause_video');
      socket.emit('sync_time', player.getCurrentTime());
    }
  }

  // ÙØ­Øµ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø± Ø­ØªÙ‰ Ø¨Ø¯ÙˆÙ† Ø¶ØºØ·
  setInterval(() => {
    if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
      if (!isRemoteUpdate) {
        socket.emit('sync_time', player.getCurrentTime());
      }
    }
  }, 3000);

  // 3. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØªØ·Ø¨ÙŠÙ‚ "ØªØ¹ÙˆÙŠØ¶ Ø§Ù„ØªØ£Ø®ÙŠØ±"
  
  socket.on('server_change_video', (videoId) => {
    player.loadVideoById(videoId);
  });

  socket.on('server_play', () => {
    isRemoteUpdate = true;
    player.playVideo();
    setTimeout(() => isRemoteUpdate = false, 500);
  });

  socket.on('server_pause', () => {
    isRemoteUpdate = true;
    player.pauseVideo();
    setTimeout(() => isRemoteUpdate = false, 500);
  });

  socket.on('server_sync_time', (serverTime) => {
    if (!player || !player.getCurrentTime) return;

    const myTime = player.getCurrentTime();
    const diff = Math.abs(myTime - serverTime);

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø£ÙƒØ¨Ø± Ù…Ù† Ù†ØµÙ Ø«Ø§Ù†ÙŠØ©ØŒ Ù‚Ù… Ø¨Ø§Ù„ØªØµØ­ÙŠØ­
    if (diff > 0.5) {
      isRemoteUpdate = true;
      
      // Ø§Ù„Ø­ÙŠÙ„Ø© Ù‡Ù†Ø§: Ù†Ù‚ÙØ² Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ„Ù… + ÙˆÙ‚Øª Ø§Ù„ØªØ¹ÙˆÙŠØ¶
      // Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ ÙƒØ¨ÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ (ØªÙ‚Ø¯ÙŠÙ… ÙŠØ¯ÙˆÙŠ) ÙÙ„Ø§ Ù†Ø¶ÙŠÙ Ø§Ù„ØªØ¹ÙˆÙŠØ¶
      if (diff < 5) {
          player.seekTo(serverTime + latencyCorrection);
      } else {
          player.seekTo(serverTime); // Ø§Ù†ØªÙ‚Ø§Ù„ Ø¹Ø§Ø¯ÙŠ (Seek)
      }
      
      setTimeout(() => isRemoteUpdate = false, 800);
    }
  });

</script>
</body>
</html>