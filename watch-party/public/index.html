<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø³ÙŠÙ†Ù…Ø§ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* 1. ØªØµÙ…ÙŠÙ… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø§Ù… */
    * { box-sizing: border-box; }
    body { 
      background-color: #121212; 
      color: #e0e0e0; 
      font-family: 'Tajawal', sans-serif; 
      margin: 0; 
      height: 100vh;
      overflow: hidden; /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø© */
    }

    /* Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© */
    .main-layout {
      display: flex;
      height: 100vh;
    }

    /* Ù‚Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (ÙŠØ³Ø§Ø± Ø£Ùˆ ÙŠÙ…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©) */
    .video-section {
      flex: 3; /* ÙŠØ£Ø®Ø° 75% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    /* Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    .chat-section {
      flex: 1; /* ÙŠØ£Ø®Ø° 25% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
      background: #1e1e1e;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* 2. Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
    .controls {
      width: 100%;
      max-width: 900px;
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }
    
    input.url-input {
      flex-grow: 1;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #444;
      background: #333;
      color: white;
    }

    button.btn-play {
      background: #e50914;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    button.btn-play:hover { background: #b20710; }

    .video-wrapper {
      width: 100%;
      max-width: 900px;
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.8);
    }
    .video-wrapper iframe { width: 100%; height: 100%; }

    /* 3. Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    .chat-header {
      padding: 15px;
      background: #252525;
      border-bottom: 1px solid #333;
      text-align: center;
      font-weight: bold;
      color: #e50914;
    }

    .chat-messages {
      flex-grow: 1;
      padding: 15px;
      overflow-y: auto; /* Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø· */
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      background: #333;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 90%;
      font-size: 0.9rem;
    }
    
    .message.mine {
      background: #e50914; /* Ø±Ø³Ø§Ø¦Ù„ÙŠ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± */
      color: white;
      align-self: flex-end; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø± */
    }
    
    .msg-author {
      font-size: 0.75rem;
      color: #aaa;
      margin-bottom: 2px;
      display: block;
    }
    .message.mine .msg-author { color: #ffd1d1; }

    .chat-input-area {
      padding: 15px;
      background: #252525;
      border-top: 1px solid #333;
      display: flex;
      gap: 5px;
    }
    
    .chat-input-area input {
      flex-grow: 1;
      padding: 10px;
      border-radius: 20px;
      border: none;
      background: #444;
      color: white;
    }

    /* Ù„Ù„ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 768px) {
      .main-layout { flex-direction: column; overflow: auto; }
      .video-section { height: 60vh; flex: none; }
      .chat-section { height: 40vh; flex: none; }
    }
  </style>
</head>
<body>

<div class="main-layout">
  
  <div class="video-section">
    <div class="controls">
      <input type="text" id="videoLink" class="url-input" placeholder="Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨...">
      <button onclick="sendVideo()" class="btn-play">ØªØ´ØºÙŠÙ„</button>
    </div>
    <div class="video-wrapper">
      <div id="player"></div>
    </div>
  </div>

  <div class="chat-section">
    <div class="chat-header">ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ’¬</div>
    <div class="chat-messages" id="messagesList">
      <div class="message" style="background: transparent; color: #666; text-align: center;">
        Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§!
      </div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="handleEnter(event)">
      <button onclick="sendMessage()" class="btn-play" style="border-radius: 50%; width: 40px; height: 40px; padding: 0;">â¤</button>
    </div>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let player;
  let isRemoteUpdate = false;
  const latencyCorrection = 0.3; 

  // 1. Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
  let myName = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±:") || "Ù…Ø´Ø§Ù‡Ø¯ Ù…Ø¬Ù‡ÙˆÙ„";

  // --- ÙƒÙˆØ¯ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚) ---
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      videoId: 'M7lc1UVf-VE',
      playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1 },
      events: { 'onStateChange': onPlayerStateChange }
    });
  }

  function getVideoId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }

  function sendVideo() {
    const url = document.getElementById('videoLink').value;
    const videoId = getVideoId(url);
    if(videoId) socket.emit('change_video', videoId);
  }

  function onPlayerStateChange(event) {
    if (isRemoteUpdate) return;
    if (event.data === YT.PlayerState.PLAYING) {
      socket.emit('play_video');
      socket.emit('sync_time', player.getCurrentTime());
    } else if (event.data === YT.PlayerState.PAUSED) {
      socket.emit('pause_video');
      socket.emit('sync_time', player.getCurrentTime());
    }
  }

  // --- ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
  
  function sendMessage() {
    const input = document.getElementById('msgInput');
    const msg = input.value.trim();
    if (msg) {
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
      socket.emit('send_msg', { name: myName, text: msg });
      input.value = '';
    }
  }

  function handleEnter(e) {
    if (e.key === 'Enter') sendMessage();
  }

  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  socket.on('receive_msg', (data) => {
    const list = document.getElementById('messagesList');
    const div = document.createElement('div');
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const isMine = data.name === myName;
    div.className = 'message' + (isMine ? ' mine' : '');
    
    div.innerHTML = `
      <span class="msg-author">${isMine ? 'Ø£Ù†Øª' : data.name}</span>
      ${data.text}
    `;
    
    list.appendChild(div);
    list.scrollTop = list.scrollHeight; // Ù†Ø²ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
  });

  // --- Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚) ---
  socket.on('server_change_video', (id) => player.loadVideoById(id));
  
  socket.on('server_play', () => {
    isRemoteUpdate = true;
    player.playVideo();
    setTimeout(() => isRemoteUpdate = false, 500);
  });

  socket.on('server_pause', () => {
    isRemoteUpdate = true;
    player.pauseVideo();
    setTimeout(() => isRemoteUpdate = false, 500);
  });

  socket.on('server_sync_time', (serverTime) => {
    if (!player || !player.getCurrentTime) return;
    const diff = Math.abs(player.getCurrentTime() - serverTime);
    if (diff > 0.5) {
      isRemoteUpdate = true;
      if (diff < 5) player.seekTo(serverTime + latencyCorrection);
      else player.seekTo(serverTime);
      setTimeout(() => isRemoteUpdate = false, 800);
    }
  });

</script>
</body>
</html>