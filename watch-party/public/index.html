<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø³ÙŠÙ†Ù…Ø§ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¨Ø³ÙŠØ·Ø© */
    * { box-sizing: border-box; }
    body { background-color: #121212; color: #e0e0e0; font-family: 'Tajawal', sans-serif; margin: 0; height: 100vh; overflow: hidden; }
    .main-layout { display: flex; height: 100vh; }
    .video-section { flex: 3; padding: 20px; display: flex; flex-direction: column; background: #000; position: relative;}
    .chat-section { flex: 1; background: #1e1e1e; border-right: 1px solid #333; display: flex; flex-direction: column; height: 100%; }
    
    .controls { width: 100%; display: flex; gap: 10px; margin-bottom: 15px; z-index: 10; }
    input.url-input { flex-grow: 1; padding: 10px; background: #333; border: 1px solid #444; color: white; border-radius: 5px; }
    button { background: #e50914; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; }
    
    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
    .player-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
    
    /* Ù…Ø´ØºÙ„ ÙŠÙˆØªÙŠÙˆØ¨ */
    .video-wrapper-yt { width: 100%; aspect-ratio: 16/9; display: none; } /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    .video-wrapper-yt iframe { width: 100%; height: 100%; }

    /* Ù…Ø´ØºÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Cima4u) */
    video#html5Player { width: 100%; max-height: 80vh; display: none; outline: none; } /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */

    /* Ø§Ù„Ø´Ø§Øª */
    .chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .message { background: #333; padding: 8px 12px; border-radius: 8px; max-width: 90%; font-size: 0.9rem; }
    .message.mine { background: #e50914; align-self: flex-end; }
    .msg-author { font-size: 0.75rem; color: #aaa; display: block; margin-bottom: 2px; }
    .chat-input-area { padding: 15px; background: #252525; display: flex; gap: 5px; }
    .chat-input-area input { flex-grow: 1; padding: 10px; border-radius: 20px; border: none; background: #444; color: white; }

    @media (max-width: 768px) { .main-layout { flex-direction: column; overflow: auto; } .video-section { height: 60vh; flex: none; } .chat-section { height: 40vh; flex: none; } }
  </style>
</head>
<body>

<div class="main-layout">
  
  <div class="video-section">
    <div class="controls">
      <input type="text" id="videoLink" class="url-input" placeholder="Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± mp4...">
      <button onclick="processLink()">ØªØ´ØºÙŠÙ„</button>
    </div>

    <div class="player-container">
      <div class="video-wrapper-yt" id="ytWrapper">
        <div id="ytPlayer"></div>
      </div>

      <video id="html5Player" controls playsinline>
        <source src="" type="video/mp4">
        Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
      </video>
    </div>
  </div>

  <div class="chat-section">
    <div class="chat-messages" id="messagesList"></div>
    <div class="chat-input-area">
      <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="handleEnter(event)">
      <button onclick="sendMessage()">â¤</button>
    </div>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let ytPlayer;
  const html5Player = document.getElementById('html5Player');
  const ytWrapper = document.getElementById('ytWrapper');
  
  let isRemoteUpdate = false;
  let currentMode = 'none'; // 'youtube' or 'mp4'
  const latencyCorrection = 0.3;
  
  let myName = prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±:") || "Ø²Ø§Ø¦Ø±";

  // -----------------------------------------
  // 1. Ù…Ù†Ø·Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´ØºÙ„
  // -----------------------------------------
  function processLink() {
    const url = document.getElementById('videoLink').value;
    // Ù‡Ù„ Ù‡Ùˆ ÙŠÙˆØªÙŠÙˆØ¨ØŸ
    const ytId = getVideoId(url);
    
    if (ytId) {
      socket.emit('change_video', { type: 'youtube', src: ytId });
    } else {
      // Ù†ÙØªØ±Ø¶ Ø£Ù†Ù‡ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± mp4
      socket.emit('change_video', { type: 'mp4', src: url });
    }
  }

  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  socket.on('server_change_video', (data) => {
    currentMode = data.type;
    
    if (currentMode === 'youtube') {
      html5Player.style.display = 'none';
      html5Player.pause();
      ytWrapper.style.display = 'block';
      if(ytPlayer && ytPlayer.loadVideoById) ytPlayer.loadVideoById(data.src);
    
    } else if (currentMode === 'mp4') {
      ytWrapper.style.display = 'none';
      if(ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
      
      html5Player.style.display = 'block';
      html5Player.src = data.src;
      html5Player.play();
    }
  });

  // -----------------------------------------
  // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´ØºÙ„ YouTube
  // -----------------------------------------
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  function onYouTubeIframeAPIReady() {
    ytPlayer = new YT.Player('ytPlayer', {
      height: '100%', width: '100%',
      videoId: '',
      playerVars: { 'playsinline': 1, 'controls': 1 },
      events: { 'onStateChange': onYtStateChange }
    });
  }

  function getVideoId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }

  function onYtStateChange(event) {
    if (currentMode !== 'youtube' || isRemoteUpdate) return;
    if (event.data === YT.PlayerState.PLAYING) emitEvent('play', ytPlayer.getCurrentTime());
    else if (event.data === YT.PlayerState.PAUSED) emitEvent('pause', ytPlayer.getCurrentTime());
  }

  // -----------------------------------------
  // 3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´ØºÙ„ HTML5 (Cima4u)
  // -----------------------------------------
  html5Player.onplay = () => { if(!isRemoteUpdate && currentMode === 'mp4') emitEvent('play', html5Player.currentTime); };
  html5Player.onpause = () => { if(!isRemoteUpdate && currentMode === 'mp4') emitEvent('pause', html5Player.currentTime); };
  html5Player.onseeked = () => { if(!isRemoteUpdate && currentMode === 'mp4') emitEvent('sync', html5Player.currentTime); };

  // -----------------------------------------
  // 4. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø´ØºÙ„ÙŠÙ†)
  // -----------------------------------------
  function emitEvent(action, time) {
    if (action === 'play') { socket.emit('play_video'); socket.emit('sync_time', time); }
    if (action === 'pause') { socket.emit('pause_video'); socket.emit('sync_time', time); }
    if (action === 'sync') { socket.emit('sync_time', time); }
  }

  socket.on('server_play', () => {
    isRemoteUpdate = true;
    if (currentMode === 'youtube' && ytPlayer.playVideo) ytPlayer.playVideo();
    else if (currentMode === 'mp4') html5Player.play();
    setTimeout(() => isRemoteUpdate = false, 500);
  });

  socket.on('server_pause', () => {
    isRemoteUpdate = true;
    if (currentMode === 'youtube' && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
    else if (currentMode === 'mp4') html5Player.pause();
    setTimeout(() => isRemoteUpdate = false, 500);
  });

  socket.on('server_sync_time', (serverTime) => {
    let myTime = 0;
    if (currentMode === 'youtube' && ytPlayer.getCurrentTime) myTime = ytPlayer.getCurrentTime();
    else if (currentMode === 'mp4') myTime = html5Player.currentTime;

    const diff = Math.abs(myTime - serverTime);
    if (diff > 0.5) {
      isRemoteUpdate = true;
      const newTime = (diff < 5) ? serverTime + latencyCorrection : serverTime;
      
      if (currentMode === 'youtube') ytPlayer.seekTo(newTime);
      else if (currentMode === 'mp4') html5Player.currentTime = newTime;

      setTimeout(() => isRemoteUpdate = false, 800);
    }
  });

  // -----------------------------------------
  // 5. Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
  // -----------------------------------------
  const messagesList = document.getElementById('messagesList');
  function appendMessageToScreen(data) {
    const div = document.createElement('div');
    div.className = 'message' + (data.name === myName ? ' mine' : '');
    div.innerHTML = `<span class="msg-author">${data.name}</span>${data.text}`;
    messagesList.appendChild(div);
    messagesList.scrollTop = messagesList.scrollHeight;
  }
  socket.on('load_history', (hist) => { messagesList.innerHTML = ''; hist.forEach(appendMessageToScreen); });
  socket.on('receive_msg', appendMessageToScreen);
  
  function sendMessage() {
    const input = document.getElementById('msgInput');
    if (input.value.trim()) { socket.emit('send_msg', { name: myName, text: input.value.trim() }); input.value = ''; }
  }
  function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

</script>
</body>
</html>
